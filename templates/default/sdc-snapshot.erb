#!/bin/bash

set -e

export SSH_AUTH_SOCK=/dev/null
export SDC_ACCOUNT="<%= node['sdc']['account_name'] %>"
export SDC_URL="<%= node['sdc']['api_endpoint'] %>"
export SDC_KEY_ID=`ssh-keygen -l -f ~/.ssh/sdc-snapshot.pub | awk '{print $2}' | tr -d '\n'`
export MAX_SNAPSHOTS=10

MACHINE=`zonename`

## functions
count_snapshots () {
  SNAPSHOT_COUNT=`sdc-listmachinesnapshots --keyId $SDC_KEY_ID $MACHINE | grep state | grep -c created`
}

create_snapshot () {
  sdc-createmachinesnapshot --keyId "$SDC_KEY_ID" --machine $MACHINE
}

oldest_snapshots () {
  sdc-listmachinesnapshots --keyId "$SDC_KEY_ID" $MACHINE | grep -B 1 "\"state\": \"created\"" | grep "\name\"" | tac | tail +10 | awk 'BEGIN{FS="\""}{print $4}'
}

delete_oldest_snapshots () {
  for snapshot in `oldest_snapshots`
    do
      echo "[`date`] deleting snapshot $snapshot..."
      sdc-deletemachinesnapshot --debug --keyId "$SDC_KEY_ID" --snapshot "$snapshot" $MACHINE
    done
}

## delete all but the $MAX_SNAPSHOTS most recent snapshots and create a new one
count_snapshots

while [ $SNAPSHOT_COUNT -ge $MAX_SNAPSHOTS ]
  do
    delete_oldest_snapshots
    SNAPSHOT_COUNT=$(($SNAPSHOT_COUNT - 1))
  done

echo "[`date`] creating snapshot..."
create_snapshot
